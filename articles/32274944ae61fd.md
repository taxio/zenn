---
title: "Goã®ORMã€Œentã€ã§æ„å›³ã—ãªã„UPDATE/DELETE ALLã‚’é˜»æ­¢ã™ã‚‹"
emoji: "ğŸš§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go", "ent", "orm"]
published: true
---

ORM (ã‚‚ã£ã¨è¨€ã†ã¨ query builder) ã‚ã‚‹ã‚ã‚‹ã ãŒã€WHERE å¥ã®çµ„ç«‹æ™‚ã«ä½•ã‚‰ã‹ã®ãƒã‚°ã§æ¡ä»¶ãŒç©ºã«ãªã£ã¦ã—ã¾ã£ã¦ã€æ„å›³ã›ãš UPDATE/DELETE ALL ã‚’ç™ºè¡Œã—ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹ã€‚

[gorm](https://github.com/go-gorm/gorm) ãªã‚“ã‹ã ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `gorm.ErrMissingWhereClause` ãŒè¿”ã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€ã‚‚ã— UPDATE/DELETE ALL ã—ãŸã„ã®ã§ã‚ã‚Œã° `AllowGlobalUpdate: true` ã¨è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

https://gorm.io/docs/gorm_config.html#AllowGlobalUpdate

ã¡ãªã¿ã« MySQL ã§ã¯ `--safe-updates` ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§é˜²ãã“ã¨ãŒã§ãã‚‹ã®ã§ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«ã‚‚ä¾ã‚‹ã ã‚ã†ãŒ DBMS å´ã§é˜»æ­¢ã§ãã‚‹ãªã‚‰ãã‚Œã«è¶Šã—ãŸã“ã¨ã¯ãªã„ã€‚

https://dev.mysql.com/doc/refman/8.0/ja/mysql-tips.html#safe-updates

ã•ã¦ã€Go è£½ã® ORM ã®1ã¤ã§ã‚ã‚‹ [ent](https://github.com/ent/ent) ã§ã¯ã€ã“ã® Global Update ã‚’é˜²ãæ©Ÿæ§‹ãŒ (ãƒ‘ãƒƒã¨èª¿ã¹ãŸæ„Ÿã˜) å­˜åœ¨ã—ãªã„ã€‚

ä»Šå›ã¯ WHERE å¥ã®ç„¡ã„ UPDATE/DELETE ãŒå®Ÿè¡Œã•ã‚Œã‚‹æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’è¨˜ã™ã€‚

## Mutation ãŒ `predicates` ã‚’è¿”ã™ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œã‚‹
WHERE å¥ã®æ¡ä»¶ã«ç›¸å½“ã™ã‚‹å¤‰æ•° `predicates` ã¯ã€ç”Ÿæˆã•ã‚Œã‚‹å„ãƒ¢ãƒ‡ãƒ«ã® `Mutation` ã®å†…éƒ¨ã« unexported ãªå¤‰æ•°ã¨ã—ã¦ä¿æŒã•ã‚Œã¦ã„ã‚‹ã€‚
ã“ã‚Œã® `len()` ã‚’å–ã£ã¦0ãªã‚‰ã°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã›ã°ã‚ˆã„ã®ã ãŒã€Getter ã‚‚å­˜åœ¨ã—ãªã„ã®ã§ `reflect` ã‚’ä½¿ã‚ãªã„é™ã‚Šå–å¾—ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã€‚

ã¨ã„ã†ã“ã¨ã§ `predicates` ã®ã‚¹ãƒ©ã‚¤ã‚¹ã®é•·ã•ã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§å®šç¾©ã™ã‚‹ã€‚

```:mutation_predicates.tmpl
{{ define "mutation_predicates" }}

{{ $pkg := base $.Config.Package }}
{{ template "header" $ }}

{{ range $n := $.Nodes }}
  func (m *{{ print $n.Name "Mutation" }}) GetPredicatesSize() int {
    return len(m.predicates)
  }
{{ end }}

{{ end }}
```

ã“ã‚Œã§å„ãƒ¢ãƒ‡ãƒ«ã® Mutation ãŒå†…éƒ¨ã«æŒã¤ `predicates` ã®æ•°ãŒè¿”ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

## ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ•ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
ã‚¹ã‚­ãƒ¼ãƒãƒ•ãƒƒã‚¯ã§ã¡ã¾ã¡ã¾ Hook ã‚’ä½œã£ã¦ã‚‚è‰¯ã„ãŒé¢å€’ãªã®ã§ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ•ãƒƒã‚¯ã§å…¨ãƒ¢ãƒ‡ãƒ«ã® UPDATE/DELETE ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ Hook ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ç”Ÿæˆã™ã‚‹ã€‚

```:prevent_global_update_hook.tmpl
{{ define "hook/prevent_global_update" }}

{{ with extend $ "Package" "hook" }}
  {{ template "header" . }}
{{ end }}

func PreventGlobalUpdate() ent.Hook {
  return On(
    func(next ent.Mutator) ent.Mutator {
      return ent.MutateFunc(func(ctx context.Context, m ent.Mutation) (ent.Value, error) {
        switch mut := m.(type) {
          {{ range $n := $.Nodes }}
          case *ent.{{ print $n.Name "Mutation" }}:
            if mut.GetPredicatesSize() == 0 {
              return nil, errors.New("prevented global update")
            }
          {{ end }}
        }
        return next.Mutate(ctx, m)
      })
    },
    ent.OpDelete | ent.OpUpdate,
  )
}

{{ end }}
```

å¾Œã¯ `go generate` ã—ã¦ã€ã“ã‚Œã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆæ™‚ã«æŒ‡å®šã™ã‚‹ã ã‘ã€‚

```go
client := ent.NewClient()
client.Use(hook.PreventGlobalUpdate())
```

ä»¥ä¸Šã€‚
