---
title: "RIP-7560: Native Account Abstraction"
emoji: "ğŸ‘›"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AccountAbstraction", "Ethereum"]
publication_name: "sivira_inc"
published: false
---

å…ˆæ—¥ ERC-4337 ã® Author ãŸã¡ã‹ã‚‰ "RIP-7650 Native Account Abstraction" ã¨ã„ã† Proposal ãŒæå‡ºã•ã‚Œã¾ã—ãŸã€‚

https://github.com/ethereum/RIPs/pull/3

description ã‚’è¦‹æ¯”ã¹ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ãŒã€ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹ãƒ¬ã‚¤ãƒ¤ã«æ‰‹ã‚’å…¥ã‚Œã¦æœ¬æ ¼çš„ã« Native Account Abstraction ã‚’é”æˆã™ã‚‹ãŸã‚ã® Proposal ã«ãªã£ã¦ã„ã¾ã™ã€‚

> An account abstraction proposal which completely avoids consensus-layer protocol changes, instead relying on higher-layer infrastructure.
> -- [ERC-4337](https://eips.ethereum.org/EIPS/eip-4337)

> An account abstraction proposal that introduces consensus-layer protocol changes, instead of relying on higher-layer infrastructure.
> -- [RIP-7560](https://github.com/eth-infinitism/RIPs/blob/e8af8009251f24e67311e0d955e7a951284717fc/RIPS/rip-7560.md)

RIP ã¨ã„ã†èãæ…£ã‚Œãªã„ prefix ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ Rollup Improvement Proposals ã®ç•¥ã§ã€Ethereum ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹ãƒ­ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ã®æ¨™æº–åŒ–ã‚’æä¾›ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

ãŸã ã—æ¨™æº–ã¨ã¯ã„ã£ã¦ã‚‚å¸¸ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€Ethereum ã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦ã“ã‚Œã‚’å¼·åˆ¶ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

https://github.com/ethereum/RIPs

æœ¬è¨˜äº‹ã§ã¯ RIP-7650 ã§ææ¡ˆã•ã‚ŒãŸ AA ã®ä»•æ§˜ã‚’è¿½ã„ãªãŒã‚‰ã€ERC-4337 ã¨ä½•ãŒé•ã†ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

## Account Abstraction ãŠã•ã‚‰ã„
> In short, account abstraction means that not only the execution of a transaction can be arbitrarily complex computation logic as specified by the EVM, but also the authorization logic of a transaction would be opened up so that users could create accounts with whatever authorization logic they want.
> -- https://ethereum-magicians.org/t/implementing-account-abstraction-as-part-of-eth1-x/4020

Account Abstraction ã¨ã¯ãƒ¦ãƒ¼ã‚¶ãŒ Tx ã®èªå¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä»»æ„ã«è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚’ç›®æ¨™ã¨ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’é”æˆã™ã‚‹ãŸã‚ã«ã„ãã¤ã‹ã®è§’åº¦ã‹ã‚‰ Proposal ãŒææ¡ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
è©³ã—ãã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚

https://zenn.dev/sivira_inc/articles/d041f1ac44ca1e

https://zenn.dev/sivira_inc/articles/34e8147f206ff5

## RIP-7560 ã®ä»•æ§˜ã¨ ERC-4337 ã¨ã®å·®åˆ†
ã–ã£ãã‚Šä¸€è¨€ã§ã„ã†ã¨ã€Bundler ã¨ EntryPoint ãŒ Core ã«ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£…ã•ã‚Œã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ã¯ã„ã¤ã‚‚é€šã‚Š RPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦é€šå¸¸ã® EOA èµ·ç‚¹ã® Tx ã‚’æŠ•ã’ã‚‹ã‚ˆã†ã«ã€AA ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Œã°ãã® Tx ãŒ Block ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚

EIP-86 ã‚„ EIP-2938 ã§é”æˆã—ã‚ˆã†ã¨ã—ã¦ã„ãŸ Core ã§ã® AA ã‚’ ERC-4337 ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è»¸ã«ã‚„ã‚Šç›´ã—ãŸã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

### AA Transactions
EIP-2718 ã«å‰‡ã£ã¦ Account Abstraction ç”¨ã®æ–°ã—ã„ Transaction Type (`AA_TX_TYPE` = 0x04) ãŒå®šç¾©ã•ã‚Œã¾ã—ãŸã€‚

payload ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```
0x04 || 0x00 || rlp([
  chainId, sender, nonce, builderFee,
  callData, paymasterData, deployerData,
  maxPriorityFeePerGas, maxFeePerGas,
  validationGasLimit, paymasterGasLimit, callGasLimit,
  accessList, signature
])
```

Transaction Hash ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã¾ã™ã€‚

```
keccak256(AA_TX_TYPE || 0x00 || rlp(transaction_payload)
```

ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆä¸Šã§æ¸¡ã£ã¦ãã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```solidity
struct TransactionType4 {
    address sender;
    uint256 nonce;
    uint256 validationGasLimit;
    uint256 paymasterGasLimit;
    uint256 callGasLimit;
    uint256 maxFeePerGas;
    uint256 maxPriorityFeePerGas;
    uint256 builderFee;
    bytes paymasterData;
    bytes deployerData;
    bytes callData;
    bytes signature;
}
```

UserOperation ã¨ã»ã¼åŒã˜ã‚ˆã†ãª Payload ã«ãªã£ã¦ã„ã¾ã™ã€‚

ä»¥å‰ã¯ `maxFeePerGas` ã¨ `maxPriorityFeePerGas` ã¯ Bundler ã«å¯¾ã™ã‚‹ã‚¬ã‚¹æ”¯æ‰•ã„ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãªã£ã¦ã„ã¾ã—ãŸãŒã€ä»Šå›ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£…ã«ãªã‚‹ãŸã‚é€šå¸¸ã®ã‚¬ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨åŒæ§˜ã«æ‰±ã‚ã‚Œã¾ã™ã€‚

`buidlerFee` ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ã‚¬ã‚¹ä»£ã¨ã¯åˆ¥ã§ Block builder (Block header ã® `coinbase`) ã«æ”¯æ‰•ã‚ã‚Œã‚‹ãƒãƒƒãƒ—ã«ãªã‚Šã¾ã™ã€‚
L2 Rollup ãªã©ã® offchain ä½œæ¥­ã§ã¯ L1 ã«å¯¾ã™ã‚‹è²»ç”¨ã¯ L2 å´ã®ã‚¬ã‚¹å¤‰å‹•ã¨ã¯åˆ¥è»¸ã§ç™ºç”Ÿã™ã‚‹ãŸã‚ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

### å®Ÿè¡Œã®æµã‚Œ
å¤§æ ã¯ ERC-4337 ã¨å¤‰ã‚ã£ã¦ã„ç„¡ã•ãã†ã§ã™ã€‚
ä»¥ä¸‹ã®è¨˜äº‹ã§åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ã„ã¾ã™ã€‚

https://zenn.dev/taxio/articles/834e6a04bd6b80

ãŸã ã— Core ã«å®Ÿè£…ã•ã‚ŒãŸå½±éŸ¿ã§ Contract ä¸Šã§è¦‹ãˆã‚‹ Transaction Property ãŒä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰åŒ–ã—ã¾ã™ã€‚

* `msg.sender`: `AA_ENTRY_POINT` (`address(7560)`).
  * Sender deployment frame ã§ã¯ `AA_SENDER_CREATOR` (`address(ffff7560)`)
* `tx.origin`: `sender` address

`tx.origin` ãŒã¡ã‚ƒã‚“ã¨ Contract Account ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã£ãŸã®ãŒã€Native Account Abstraction ã£ã½ãã¦ã„ã„ã§ã™ã­ã€‚
ERC-4337 ã§ã¯ Bundler ã® EOA address ãŒå…¥ã£ã¦ã„ã¾ã—ãŸã€‚

æ¬¡ã§ã¯ ERC-4337 ã«ã‚‚å­˜åœ¨ã—ãŸ Validation (Verification) Phase ã¨ Execution Phase ã§ãã‚Œãã‚Œä½•ãŒèµ·ãã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

#### Validation Phase
ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯å…¨ã¦ã®å‡¦ç†ã¯ revert ã™ã‚‹ã“ã¨ãªãæ­£å¸¸ã«å®Œäº†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
revert ã™ã‚‹å ´åˆã€Block ã«ã¯å–ã‚Šè¾¼ã¾ã‚Œã¾ã›ã‚“ã€‚(ãã‚‚ãã‚‚ Node RPC å´ã§å¼¾ã‹ã‚Œã‚‹ã¯ãš)
æ¬¡ã®4ã¤ã® frame ã‹ã‚‰æ§‹æˆã•ã‚Œã¾ã™ã€‚

##### Nonce validation frame
`AA_ENTRY_POINT` ãŒ `sender` ã® nonce ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã¾ã™ã€‚
nonce ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ ERC-4337 ã® EntryPoint ã¨åŒã˜ Two-dimensional nonce [^two-dimensional-nonce] ã§ã™ã€‚
NonceManager ãŒã©ã†é‹ç”¨ã•ã‚Œã‚‹ã‹ã¯è­°è«–ä¸­ã®ã‚ˆã†ã§ã™ã€‚

[^two-dimensional-nonce]: https://docs.google.com/document/d/1MywdH_TCkyEjD3QusLZ_kUZg4ZEI00qp97mBze9JI4k/edit

##### Sender deployment frame
`AA_SENDER_CREATOR` ãŒ `deployerData` ã«å¾“ã£ã¦ Account Contract ã‚’ deploy ã—ã¾ã™ã€‚

ã“ã® frame ã§ã® gas ã¯ `validationGasLimit` ã«å«ã¾ã‚Œã¾ã™ã€‚

##### Sender validation frame
`AA_ENTRY_POINT` ãŒ Contract Account ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```solidity
function validateTransaction(
  uint256 version,
  bytes32 txHash,
  bytes transaction
) external returns (uint256 validationData);
```

`transaction` ã¯ `TransactionType4` ãŒ ABI Encode ã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚
å°†æ¥çš„ã« Transaction ã®æ§‹é€ ãŒå¤‰ã‚ã£ãŸæ™‚ã«ã‚·ã‚°ãƒãƒãƒ£ãŒå¤‰æ›´ã•ã‚Œãªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¦ã€`version` ãŒãã®æ§‹é€ ä½“ã® revision ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

ã“ã® frame ã§ã® gas ã¯ `validationGasLimit` ã«å«ã¾ã‚Œã¾ã™ã€‚

##### Paymaster validation frame
`AA_SENDER_CREATOR` ãŒ Paymaster ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```solidity
function validatePaymasterTransaction(
  uint256 version,
  bytes32 txHash,
  bytes transaction
) external returns (bytes context, uint256 validationData);
```

ã“ã“ã§ã® gas ã¯ `paymasterGasLimit` ã«å«ã¾ã‚Œã¾ã™ã€‚

#### Execution Phase
##### Sender execution frame
`AA_SENDER_CREATOR` ãŒ Contract Account ã«å¯¾ã—ã¦ `callData` ã‚’ invoke ã—ã¾ã™ã€‚
ã“ã“ã§ revert ãŒèµ·ãã¦ã‚‚ã€Validation phase ã®å‡¦ç†ã¯ revert ã•ã‚Œã¾ã›ã‚“ã€‚

ã“ã® frame ã§ã® gas ã¯ `callGasLimit` ã«å«ã¾ã‚Œã¾ã™ã€‚

##### Paymaster post-transaction frame
`AA_SENDER_CREATOR` ãŒ Paymaster ã®ä»¥ä¸‹ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```solidity
function postPaymasterTransaction(
  bool success, // Sender execution frame ãŒ revert ã›ãšã«å®Œäº†ã—ãŸã‹
  uint256 actualGasCost,
  bytes context
) external;
```

Sender execution frame ãŒ revert ã•ã‚Œã¦ã‚‚ã€ã“ã® frame ã¯å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã“ã® frame ã§ã® gas ã¯ `paymasterGasLimit` ã«å«ã¾ã‚Œã¾ã™ã€‚

ä»¥ä¸ŠãŒ AA Transaction å®Ÿè¡Œæ™‚ã®æµã‚Œã§ã™ã€‚
ERC-4337 ã¨åŒã˜ã§ Contract Account ã¨ Paymaster ã«ã¯ç‰¹å®šã®ã‚·ã‚°ãƒãƒãƒ£ã‚’æŒã£ãŸé–¢æ•°ã®å®Ÿè£…ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚
Core å´ãŒ Contract ã® interface ã‚’å¼·åˆ¶ã—ã¦ã„ã‚‹ã®ã¯é¢ç™½ã„ã§ã™ã­ã€‚

### Validation, Execution Tx ã®åˆ†é›¢
* Builder ã¯ AA Tx ã‚’ Validation, Execution ã®2ã¤ã® Tx ã«åˆ†é›¢ã™ã‚‹ã“ã¨ãŒã§ãã‚‹

### RPC ã¸ã®å®Ÿè£…è¿½åŠ 
Core ã¸ã®å¤‰æ›´ã®ãŸã‚ã€ãã‚Œã«è¿½éšã—ã¦ client ã® RPC ã«ã‚‚å¤‰æ›´ãŒå…¥ã‚Šã¾ã™ã€‚
Proposal ã§æ›¸ã„ã¦ã‚ã‚‹ã®ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

* `eth_sendTransaction`, `eth_sendRawTransaction`
* `eth_signTransaction`
* `eth_getTransactionReceipt`
  * Validation phase å´ã® Tx hash ã§å–å¾—ãŒå¯èƒ½
* `eth_call`
* `eth_estimateGasAccountAbstraction` (New)
  * `validationGasLimit`, `paymasterGasLimit`, `callGasLimit`, `builderFee` ãŒå–å¾—å¯èƒ½
  * `builderFee` ã‚’è¿”ã—ã¦ã„ã‚‹ã®ã¯ã€L2 å´ãŒä¸€å®šå€¤ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

## Native AA ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ L2 ã¨ã®æ¯”è¼ƒ
### zkSync

### StarkNet

### ä»Šå¾Œã® L2 å¯¾å¿œã«ã¤ã„ã¦ã®è€ƒå¯Ÿ

## çµ‚ã‚ã‚Šã«
RIP-7560 ã®ä»•æ§˜ã‚’è¦‹ã¦ã„ãã¾ã—ãŸã€‚
