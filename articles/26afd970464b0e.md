---
title: "ISUCON12本選の延長戦で一から解き直して40万点を取った"
emoji: "🪑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["isucon", "Go"]
published: false
---

こんにちは、ISUCON12本選で惨敗した taxio です。

* 当日は最終スコア21,710点というひどい結果で落ち込んでいた
* 運営様のご厚意により、競技環境が追加で1週間維持されるいわゆる延長戦に突入した
* ISUCON の環境を用意するのは大変なので、この機会を逃さず一からしっかり解き直すことにした
  * 先行してスコアを伸ばしていたチームによると40万点までは普通のチューニングで到達できるらしいので、そこまで頑張ってみることにした
* 結果400,201点まで伸ばすことができたのでそのログを残しておく
  * 当日の優勝スコアは341,258点

.
* 初期スコアは823点
  * 最初から2台構成
    * nginx, API
    * DB
* ベンチ結果から分かること
  * `POST /login` が最も叩かれていて、最も遅い
  * DB の CPU が張り付いている
  * エラーが出ている (減点・ベンチ打ち切り対象)
    * `POST /login` のタイムアウト
    * `user_sessions` の Deadlock
* 考えたこと
  * DB の CPU 使用率を下げたい
  * ベンチのエラーを無くしたい
* やったこと
  * `id_generator` を使わないようにした -> 966
    * ISUCON12予選問題でもあったやつ
  * `user_sessions` のユニーク制約を消した -> 590 (減点が消えた)
    * ユニーク制約の入った index を lock してそうだった
    * `session_id` は API 内部で生成している UUID なので、被る確率は十分低いだろうと思って消してみた
  * `user_present_all_received_history` の `user_id` と `present_all_id` に index を貼った -> 19,928
* ここで大きくスコアが変わったので、まだやれることは残っているがもう一度ベンチを取って戦略を練り直した
* ベンチ結果から分かったこと
  * またエラー率が上がった
    * また `user_sessions` が Deadlock している
    * エラーが多すぎて打ち切られている
  * DB の CPU 使用率がちょっと下がった
    * でも最後の方は張り付いている
  * `user_sessions` がスロークエリ
* 考えたこと
  * `user_sessions` の Deadlock をどうにかしないと先に進めなさそう
    * よく読んでみると、User は常に1つのセッションしか持てないようになっている
    * メモリにのせれそう
* やったこと
  * `user_sessions` をメモリにのせる -> 21,768
* しかしベンチのエラーは消えず
  * DB や API サーバのログを見ても、Deadlock が発生していたりそもそも500を返している気配がない
  * nginx が500を返していた
    * `socket() failed (24: Too many open files)`
* やったこと
  * nginx のファイルディスクリプタの上限値などを増やした -> 41,121
* ベンチ結果から分かったこと
  * DB の CPU がまたサチり始めた
* 引き続き DB の CPU 使用率を下げたい
  * DB が担っている機能を API サーバ側に移す
    * 不要なクエリの削除
    * オンメモリ化
  * 分割による負荷分散
* ここが分かれ目ポイント (だと感じた)
  * 当日僕のチームはここでひたすら N+1 を潰した
  * 前世の記憶を持っているので DB 分割をする
    * スロークエリより、遅いのはユーザ系 (`user_*`) のテーブルということが分かるので、これを UserID で水平分割したい
    * しかしマスターデータのアクセスが実装の都合上ちょっと邪魔
    * 更新頻度も低いので先にメモリにのせることにした
  * 考察
    * CPU の使用率を下げるためにやることの順番
* やったこと
  * マスターデータのオンメモリ化 -> 44,831
  * UserID で水平分割 -> 159,523
* ベンチから分かること
  * 各サーバで CPU に少し余裕が出てきた
  * API サーバ側にボトルネックが移ってきたと言えそう
  * 最も遅いエンドポイントから N+1 を潰していく
  * 考察ポイント
    * 手を付ける API の順番
      * 今回はたまたまユーザ作成, ログインの API が遅かったのでそれから手を付けた
      * 得点と直接関係無かった場合どう判断するべきか？
* やったこと
  * `obtainPresent` の N+1 を潰す -> 178748
  * `obtainItem` の N+1 を潰す -> 247445
* ベンチ
  * ガチャが引かれるようになってきた
  * ユーザ作成, ログインはまだ遅い
* やったこと
  * `drawGacha` の N+1 潰す -> 255,252
  * `obtainLoginBonus` の N+1 潰す -> 257,556
* ベンチ
  * 目ぼしい N+1 は既に潰している
  * ここからできること
    * ドメイン理解によるクエリの最適化
    * オンメモリ化
    * 無駄なログを消す
* やったこと
  * `e.Logger()` 止める -> 285,301
  * `user_bans` をオンメモリ化 -> 296,817
  * エラーログを出すのは5xx系の時だけにする -> 297,387
* ベンチ
  * The ボトルネックって感じのものが無くなった
  * クエリを減らす & メモリにのせるしか無い？
* オンメモリ化 -> 368,275
  * ひたすらやる
* API サーバ側の CPU 使用率がかなり高くなってきたので DB を1台潰して nginx に変更 -> 370,087
* pprof や netdata を止める -> 400,201

.
感想
* 30万点からはひたすらメモリにのせる戦い
* 40万点から先は Go レイヤのチューニングになりそう (他の言語は分からない)
  * Discord の感想戦を眺めてると、色々な知見が転がっていて勉強になった
